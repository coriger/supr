KISSY.add("sky/Scroller",function(a,b,c,d,e){return b.Scroller=function(c){this._type="scroller";var d={step:20,dimension:5,currentPercent:0,start:0};a.mix(d,c),b.Control.call(this,d)},b.Scroller.prototype={render:function(){var b=this,c=b.main;if(!b._isRendered){b._setHTML(),b._initDraggable(),b._registMouseWheelEvt(),b.flushUI(b.start),d.on(b.slider,"mousedown",b._getMousedownHandler,b),d.on(b.slider,"mouseup",b._getMouseupHandler,b),d.on(b.thumb,"mousedown",function(a){a.halt()}),d.on(b.body,"dblclick",function(a){a.halt()});var e=a.bind(b._getKeydownHandler,b);d.on(b.main,"mouseover",function(){d.on(document.body,"keydown",e)}),d.on(b.main,"mouseout",function(){d.remove(document.body,"keydown",e)}),b._isRendered=1}},show:function(){this.status="on",c.css(this.body,{visibility:"visible"})},hide:function(){this.scrollTo(0),this.status="off",this._hide()},_hide:function(){c.css(this.body,{visibility:"hidden"})},scrollTo:function(a){if(this.status=="off")return;var b=this,d=b.maxHeight;this.show(),a=Math.round(Math.min(a,d-b.height)),a=Math.round(Math.max(0,a)),b.currentPercent=a/d,c.css(b.thumb,{top:b.currentPercent*b.height}),b.fire("onscroll",{value:b.currentPercent})},scrollToPercent:function(a){this.scrollTo(a*this.height)},update:function(){var a=this;a.main.scrollTop=0,a._mainTop=c.offset(a.main).top,a.maxHeight=a.innerEl.offsetHeight,a.flushUI(a.currentPercent),a.fire("onscroll",{value:a.currentPercent,from:"update"})},flushUI:function(a){var b=this,c=b.slider,d=b.thumb,e=b.height,f="height",g;c.style[f]=b.main.style[f]=(e<=0?0:e)+"px",g=Math.min(Math.max(b.height/b.maxHeight*100,b.dimension),100),g==100?(b.hide(),a=0):(b.show(),d.style[f]=g+"%"),b.scrollTo(a*b.maxHeight)},setScrollHeight:function(a){a<0&&(a=0);var b=this;b.height=a,b._mainTop=c.offset(b.main).top,b.flushUI(b.currentPercent)},_setHTML:function(){var b='<div id="{id}" class="dd-scroll-bar {skin}"><div class="dd-scroll-bar-slider"><div class="dd-scroll-bar-thumb"></div> </div></div>',d=this,e=d.main,f=e.id+"-scroll-bar";d.innerEl=c.get(d.innerel,e),d.maxHeight=d.innerEl.offsetHeight,d.enableMinHeight||(d.height?d.height=Math.min(d.height,d.maxHeight):d.height=d.maxHeight);var g=c.css(e,"position");c.css(e,{position:g=="absolute"?g:"relative",height:d.height,overflow:"hidden"}),c.prepend(c.create(a.substitute(b,{id:f,skin:d.skin||""})),e),d.body=c.get("#"+f),d.slider=c.get(".dd-scroll-bar-slider",d.body),d.thumb=c.get(".dd-scroll-bar-thumb",d.body),d._mainTop=c.offset(d.main).top},_initDraggable:function(){var a=this;(new e.Draggable({node:a.thumb})).on("drag",function(b){a.scrollTo((b.top-a._mainTop)/a.height*a.maxHeight)})},_getKeydownHandler:function(a){if(a.target.tagName=="INPUT"||a.target.tagName=="TEXTAREA")return;if(a.keyCode==40||a.keyCode==74)this._basicScroll(-1),a.halt();if(a.keyCode==38||a.keyCode==75)this._basicScroll(1),a.halt()},_getMousedownHandler:function(a){var b=this,c=a.pageY-b._mainTop,d=b.thumb.offsetTop,e=c>d?-1:1;b._basicScroll(e),b.timeoutTimer=setTimeout(function(){b.interTimer=setInterval(function(){var a=b.thumb.offsetTop,d=c>a?-1:1;d!=e?clearInterval(b.interTimer):b._basicScroll(d)},10)},500)},_getMouseupHandler:function(a){clearInterval(this.interTimer),clearTimeout(this.timeoutTimer)},_basicScroll:function(a){var b=this,c=b.maxHeight*b.currentPercent,d=-a*b.step;b.scrollTo(c+d)},_onMouseWheelHandler:function(a){var b=a.deltaY;a.halt(),this._basicScroll(b)},_registMouseWheelEvt:function(){var b=this,c=b.main,e=a.bind(b._onMouseWheelHandler,b);d.on(c,"mousewheel",e),d.on(b,"dispose",function(){d.remove(c,"mousewheel",e)})},__dispose:function(){this.fire("dispose")},__construct:function(){b.Control.prototype.__construct.call(this),this.main=c.get(this.main)}},b.util.inherits(b.Scroller,b.Control),b.core.register("Scroller",b.Scroller),b.Scroller},{requires:["sky.$6855","dom","event","dd"]});