KISSY.add("app/publisher/autosave",function(a,b,c,d,e,f){function t(a,b){var c=r[a];l=a,n=b||"0",m=ENV.autosaveId||"0",q=f[a].editPostData,v(),c&&c()}function u(a){a?window.onbeforeunload=null:window.onbeforeunload=function(){return"\u8fd8\u6709\u4e00\u4e9b\u5185\u5bb9\u5c1a\u672a\u53d1\u5e03\uff0c\u786e\u5b9a\u53d6\u6d88\u5417\uff1f\u672a\u4fdd\u5b58\u7684\u6570\u636e\u4f1a\u4e22\u5931\uff01"}}function v(){function a(a){a.type=="editor-user-active"&&u(),w()}g(document,"click keydown",a),h.on("editor-user-active",a),h.on("autosave-trigger",x)}function w(){if(o)return;o=setTimeout(function(){o=null,x()},k),a.log("Enter Autosave Phase @"+ +(new Date)+", id: "+o,"info")}function x(){var c=f.submit("autosave"),e,g;if(!c||s){a.log("Drop Autosave Because Of "+(c?"Saving now":"Invaild Post Content"),"info");return}s=!0,b.show("#pb-submiting-tip"),c=a.merge(c,{autoSaveId:m,autoSaveType:n}),q&&(g=q.createTime)&&(c.createTime=g),o&&(clearTimeout(o),a.log("Abandon Current Autosave Phase, id: "+o,"info"),o=null),a.log("Autosave @"+ +(new Date),"info");if(p&&p.abort)try{p.abort()}catch(h){}e=setTimeout(function(){s||b.hide("#pb-submiting-tip"),e=null},2*j),p=d({type:"post",url:i+"/save",data:c,success:function(c){0==c.errCode?(m=c.autoSaveId,ENV.autosaveId=m,u(!0)):a.log("error: "+c.result,"error"),s=!1,e||b.hide("#pb-submiting-tip"),p=null},error:function(){a.log("error: network error!","error"),s=!0,p=null}})}var g=c.on,h=e.Dispatcher,i=e.url.host+"/autosave",j=1e3,k=15*j,l,m,n,o,p,q,r,s=!1;return r={text:function(){h.on("editor-image-upload",x)},photo:function(){h.on("editor-image-upload editor-image-delete",x)},audio:function(){h.on("editor-audio-select",x)},video:function(){h.on("editor-video-select",x)}},{init:t}},{requires:["dom","event","ajax","util.$7202","./common.$7252"]});